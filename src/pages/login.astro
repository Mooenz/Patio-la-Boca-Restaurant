---
import Layout from '@/layout/Layout.astro';
import GeneralContainer from '@/components/GeneralContainer.astro';
import { getUser } from '@/utilities/auth';

// Si el usuario ya está autenticado, redirigir al dashboard
const user = await getUser(Astro.cookies);
if (user) {
	return Astro.redirect('/dashboard');
}
---

<Layout lateralMenu={false}>
	<GeneralContainer classList="min-h-[85dvh] flex items-center justify-center">
		<div class="w-full max-w-md">
			<h1 class="text-4xl font-bold text-center mb-8 transition-base">Iniciar Sesión</h1>

			<form id="login-form" class="space-y-6 bg-background-secondary p-8 rounded-xl shadow-lg transition-base">
				<div>
					<label for="email" class="block text-sm font-medium mb-2 text-text transition-base"> Correo electrónico </label>
					<input type="email" id="email" name="email" required class="w-full px-4 py-3 rounded-lg bg-background border border-text/20 text-text focus:outline-none focus:ring-2 focus:ring-accent transition-base" placeholder="tu@email.com" />
				</div>

				<div>
					<label for="password" class="block text-sm font-medium mb-2 text-text transition-base"> Contraseña </label>
					<input type="password" id="password" name="password" required class="w-full px-4 py-3 rounded-lg bg-background border border-text/20 text-text focus:outline-none focus:ring-2 focus:ring-accent transition-base" placeholder="••••••••" />
				</div>

				<div id="error-message" class="hidden text-red-500 text-sm"></div>

				<div>
					<button type="submit" class="cursor-pointer w-full py-3 px-4 rounded-lg bg-accent hover:bg-accent-secondary text-white font-medium transition-base shadow shadow-text/5"> Iniciar Sesión </button>
					<a href="/" class="block text-center cursor-pointer w-full py-3 px-4 rounded-lg mt-4 transition-base hover:text-accent"> Volver al Inicio </a>
				</div>
			</form>
		</div>
	</GeneralContainer>
</Layout>

<script>
	const form = document.getElementById('login-form') as HTMLFormElement;
	const errorMessage = document.getElementById('error-message') as HTMLDivElement;
	const submitButton = form.querySelector('button[type="submit"]') as HTMLButtonElement;

	form.addEventListener('submit', async (e) => {
		e.preventDefault();

		const formData = new FormData(form);

		// Ocultar mensaje de error previo
		errorMessage.classList.add('hidden');
		errorMessage.textContent = '';

		// Deshabilitar el botón mientras se procesa
		submitButton.disabled = true;
		submitButton.textContent = 'Iniciando sesión...';

		try {
			const response = await fetch('/api/auth/login', {
				method: 'POST',
				body: formData,
			});

			if (response.redirected) {
				// Si hay una redirección, significa que el login fue exitoso
				window.location.href = response.url;
				return;
			}

			const data = await response.json();

			if (!response.ok) {
				throw new Error(data.error || 'Error al iniciar sesión');
			}

			// Si llegamos aquí y no hubo redirección, redirigir manualmente
			window.location.href = '/dashboard';
		} catch (error: any) {
			errorMessage.textContent = error.message || 'Error al iniciar sesión';
			errorMessage.classList.remove('hidden');
			submitButton.disabled = false;
			submitButton.textContent = form.querySelector('button[type="submit"]')?.getAttribute('data-original-text') || 'Iniciar Sesión';
		}
	});
</script>
